{"version":3,"sources":["../../../../../src/start/server/metro/metroErrorInterface.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport chalk from 'chalk';\nimport resolveFrom from 'resolve-from';\nimport { StackFrame } from 'stacktrace-parser';\nimport terminalLink from 'terminal-link';\n\nimport { Log } from '../../../log';\nimport { createMetroEndpointAsync } from '../getStaticRenderFunctions';\n// import type { CodeFrame, MetroStackFrame } from '@expo/metro-runtime/symbolicate';\n\ntype CodeFrame = {\n  content: string;\n  location?: {\n    row: number;\n    column: number;\n    [key: string]: any;\n  };\n  fileName: string;\n};\n\ntype MetroStackFrame = StackFrame & { collapse?: boolean };\n\nexport async function logMetroErrorWithStack(\n  projectRoot: string,\n  {\n    stack,\n    codeFrame,\n    error,\n  }: {\n    stack: MetroStackFrame[];\n    codeFrame: CodeFrame;\n    error: Error;\n  }\n) {\n  const { getStackFormattedLocation } = require(resolveFrom(\n    projectRoot,\n    '@expo/metro-runtime/symbolicate'\n  ));\n\n  Log.log();\n  Log.log(chalk.red('Metro error: ') + error.message);\n  Log.log();\n\n  if (codeFrame) {\n    Log.log(codeFrame.content);\n  }\n\n  if (stack?.length) {\n    Log.log();\n    Log.log(chalk.bold`Call Stack`);\n\n    const stackProps = stack.map((frame) => {\n      return {\n        title: frame.methodName,\n        subtitle: getStackFormattedLocation(projectRoot, frame),\n        collapse: frame.collapse,\n      };\n    });\n\n    stackProps.forEach((frame) => {\n      const position = terminalLink.isSupported\n        ? terminalLink(frame.subtitle, frame.subtitle)\n        : frame.subtitle;\n      let lineItem = chalk.gray(`  ${frame.title} (${position})`);\n      if (frame.collapse) {\n        lineItem = chalk.dim(lineItem);\n      }\n      Log.log(lineItem);\n    });\n  } else {\n    Log.log(chalk.gray(`  ${error.stack}`));\n  }\n}\n\nexport async function logMetroError(projectRoot: string, { error }: { error: Error }) {\n  const { LogBoxLog, parseErrorStack } = require(resolveFrom(\n    projectRoot,\n    '@expo/metro-runtime/symbolicate'\n  ));\n\n  const stack = parseErrorStack(error.stack);\n\n  const log = new LogBoxLog({\n    level: 'static',\n    message: {\n      content: error.message,\n      substitutions: [],\n    },\n    isComponentError: false,\n    stack,\n    category: 'static',\n    componentStack: [],\n  });\n\n  await new Promise((res) => log.symbolicate('stack', res));\n\n  logMetroErrorWithStack(projectRoot, {\n    stack: log.symbolicated?.stack?.stack ?? [],\n    codeFrame: log.codeFrame,\n    error,\n  });\n}\n\n/** @returns the html required to render the static metro error as an SPA. */\nexport function logFromError({ error, projectRoot }: { error: Error; projectRoot: string }): {\n  symbolicated: any;\n  symbolicate: (type: string, callback: () => void) => void;\n  codeFrame: CodeFrame;\n} {\n  const { LogBoxLog, parseErrorStack } = require(resolveFrom(\n    projectRoot,\n    '@expo/metro-runtime/symbolicate'\n  ));\n\n  const stack = parseErrorStack(error.stack);\n\n  return new LogBoxLog({\n    level: 'static',\n    message: {\n      content: error.message,\n      substitutions: [],\n    },\n    isComponentError: false,\n    stack,\n    category: 'static',\n    componentStack: [],\n  });\n}\n\n/** @returns the html required to render the static metro error as an SPA. */\nexport async function logMetroErrorAsync({\n  error,\n  projectRoot,\n}: {\n  error: Error;\n  projectRoot: string;\n}) {\n  const log = logFromError({ projectRoot, error });\n\n  await new Promise<void>((res) => log.symbolicate('stack', res));\n\n  logMetroErrorWithStack(projectRoot, {\n    stack: log.symbolicated?.stack?.stack ?? [],\n    codeFrame: log.codeFrame,\n    error,\n  });\n}\n\n/** @returns the html required to render the static metro error as an SPA. */\nexport async function getErrorOverlayHtmlAsync({\n  error,\n  projectRoot,\n}: {\n  error: Error;\n  projectRoot: string;\n}) {\n  const log = logFromError({ projectRoot, error });\n\n  await new Promise<void>((res) => log.symbolicate('stack', res));\n\n  logMetroErrorWithStack(projectRoot, {\n    stack: log.symbolicated?.stack?.stack ?? [],\n    codeFrame: log.codeFrame,\n    error,\n  });\n\n  const logBoxContext = {\n    selectedLogIndex: 0,\n    isDisabled: false,\n    logs: [log],\n  };\n  const html = `<html><head><style>#root,body,html{height:100%}body{overflow:hidden}#root{display:flex}</style></head><body><div id=\"root\"></div><script id=\"_expo-static-error\" type=\"application/json\">${JSON.stringify(\n    logBoxContext\n  )}</script></body></html>`;\n\n  const errorOverlayEntry = await createMetroEndpointAsync(\n    projectRoot,\n    // Keep the URL relative\n    '',\n    resolveFrom(projectRoot, 'expo-router/_error'),\n    {\n      dev: true,\n      platform: 'web',\n      minify: false,\n      environment: 'node',\n    }\n  );\n\n  const htmlWithJs = html.replace('</body>', `<script src=${errorOverlayEntry}></script></body>`);\n  return htmlWithJs;\n}\n"],"names":["logMetroErrorWithStack","logMetroError","logFromError","logMetroErrorAsync","getErrorOverlayHtmlAsync","projectRoot","stack","codeFrame","error","getStackFormattedLocation","require","resolveFrom","Log","log","chalk","red","message","content","length","bold","stackProps","map","frame","title","methodName","subtitle","collapse","forEach","position","terminalLink","isSupported","lineItem","gray","dim","LogBoxLog","parseErrorStack","level","substitutions","isComponentError","category","componentStack","Promise","res","symbolicate","symbolicated","logBoxContext","selectedLogIndex","isDisabled","logs","html","JSON","stringify","errorOverlayEntry","createMetroEndpointAsync","dev","platform","minify","environment","htmlWithJs","replace"],"mappings":"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"}