{"version":3,"sources":["../../../../../src/start/server/metro/withMetroMultiPlatform.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport { ConfigT } from 'metro-config';\nimport { Resolution, ResolutionContext } from 'metro-resolver';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { Log } from '../../../log';\nimport { FileNotifier } from '../../../utils/FileNotifier';\nimport { env } from '../../../utils/env';\nimport { installExitHooks } from '../../../utils/exit';\nimport { isInteractive } from '../../../utils/interactive';\nimport { learnMore } from '../../../utils/link';\nimport { loadTsConfigPathsAsync, TsConfigPaths } from '../../../utils/tsconfig/loadTsConfigPaths';\nimport { resolveWithTsConfigPaths } from '../../../utils/tsconfig/resolveWithTsConfigPaths';\nimport { WebSupportProjectPrerequisite } from '../../doctor/web/WebSupportProjectPrerequisite';\nimport { PlatformBundlers } from '../platformBundlers';\nimport {\n  EXTERNAL_REQUIRE_NATIVE_POLYFILL,\n  EXTERNAL_REQUIRE_POLYFILL,\n  getNodeExternalModuleId,\n  isNodeExternal,\n  setupNodeExternals,\n} from './externals';\nimport { isFailedToResolveNameError, isFailedToResolvePathError } from './metroErrors';\nimport { importMetroResolverFromProject } from './resolveFromProject';\nimport { getAppRouterRelativeEntryPath } from './router';\nimport { withMetroResolvers } from './withMetroResolvers';\n\ntype Mutable<T> = { -readonly [K in keyof T]: T[K] };\n\nconst debug = require('debug')('expo:start:server:metro:multi-platform') as typeof console.log;\n\nfunction withWebPolyfills(config: ConfigT, projectRoot: string): ConfigT {\n  const originalGetPolyfills = config.serializer.getPolyfills\n    ? config.serializer.getPolyfills.bind(config.serializer)\n    : () => [];\n\n  const getPolyfills = (ctx: { platform: string | null }): readonly string[] => {\n    if (ctx.platform === 'web') {\n      return [\n        // NOTE: We might need this for all platforms\n        path.join(projectRoot, EXTERNAL_REQUIRE_POLYFILL),\n        // TODO: runtime polyfills, i.e. Fast Refresh, error overlay, React Dev Tools...\n      ];\n    }\n    // Generally uses `rn-get-polyfills`\n    const polyfills = originalGetPolyfills(ctx);\n\n    return [...polyfills, EXTERNAL_REQUIRE_NATIVE_POLYFILL];\n  };\n\n  return {\n    ...config,\n    serializer: {\n      ...config.serializer,\n      getPolyfills,\n    },\n  };\n}\n\nfunction normalizeSlashes(p: string) {\n  return p.replace(/\\\\/g, '/');\n}\n\n/**\n * Apply custom resolvers to do the following:\n * - Disable `.native.js` extensions on web.\n * - Alias `react-native` to `react-native-web` on web.\n * - Redirect `react-native-web/dist/modules/AssetRegistry/index.js` to `@react-native/assets/registry.js` on web.\n * - Add support for `tsconfig.json`/`jsconfig.json` aliases via `compilerOptions.paths`.\n */\nexport function withExtendedResolver(\n  config: ConfigT,\n  {\n    projectRoot,\n    tsconfig,\n    platforms,\n    isTsconfigPathsEnabled,\n  }: {\n    projectRoot: string;\n    tsconfig: TsConfigPaths | null;\n    platforms: string[];\n    isTsconfigPathsEnabled?: boolean;\n  }\n) {\n  // Get the `transformer.assetRegistryPath`\n  // this needs to be unified since you can't dynamically\n  // swap out the transformer based on platform.\n  const assetRegistryPath = fs.realpathSync(\n    // This is the native asset registry alias for native.\n    path.resolve(resolveFrom(projectRoot, 'react-native/Libraries/Image/AssetRegistry'))\n    // NOTE(EvanBacon): This is the newer import but it doesn't work in the expo/expo monorepo.\n    // path.resolve(resolveFrom(projectRoot, '@react-native/assets/registry.js'))\n  );\n\n  const isWebEnabled = platforms.includes('web');\n\n  const { resolve } = importMetroResolverFromProject(projectRoot);\n\n  const extraNodeModules: { [key: string]: Record<string, string> } = {};\n\n  const aliases: { [key: string]: Record<string, string> } = {\n    web: {\n      'react-native': 'react-native-web',\n    },\n  };\n\n  if (isWebEnabled) {\n    // Allow `react-native-web` to be optional when web is not enabled but path aliases is.\n    extraNodeModules['web'] = {\n      'react-native': path.resolve(require.resolve('react-native-web/package.json'), '..'),\n    };\n  }\n\n  const preferredMainFields: { [key: string]: string[] } = {\n    // Defaults from Expo Webpack. Most packages using `react-native` don't support web\n    // in the `react-native` field, so we should prefer the `browser` field.\n    // https://github.com/expo/router/issues/37\n    web: ['browser', 'module', 'main'],\n  };\n\n  let tsConfigResolve = tsconfig?.paths\n    ? resolveWithTsConfigPaths.bind(resolveWithTsConfigPaths, {\n        paths: tsconfig.paths ?? {},\n        baseUrl: tsconfig.baseUrl,\n      })\n    : null;\n\n  if (isTsconfigPathsEnabled && isInteractive()) {\n    // TODO: We should track all the files that used imports and invalidate them\n    // currently the user will need to save all the files that use imports to\n    // use the new aliases.\n    const configWatcher = new FileNotifier(projectRoot, ['./tsconfig.json', './jsconfig.json']);\n    configWatcher.startObserving(() => {\n      debug('Reloading tsconfig.json');\n      loadTsConfigPathsAsync(projectRoot).then((tsConfigPaths) => {\n        if (tsConfigPaths?.paths && !!Object.keys(tsConfigPaths.paths).length) {\n          debug('Enabling tsconfig.json paths support');\n          tsConfigResolve = resolveWithTsConfigPaths.bind(resolveWithTsConfigPaths, {\n            paths: tsConfigPaths.paths ?? {},\n            baseUrl: tsConfigPaths.baseUrl,\n          });\n        } else {\n          debug('Disabling tsconfig.json paths support');\n          tsConfigResolve = null;\n        }\n      });\n    });\n\n    // TODO: This probably prevents the process from exiting.\n    installExitHooks(() => {\n      configWatcher.stopObserving();\n    });\n  } else {\n    debug('Skipping tsconfig.json paths support');\n  }\n\n  return withMetroResolvers(config, projectRoot, [\n    // Add a resolver to alias the web asset resolver.\n    (immutableContext: ResolutionContext, moduleName: string, platform: string | null) => {\n      let context = {\n        ...immutableContext,\n      } as Mutable<ResolutionContext> & {\n        mainFields: string[];\n        customResolverOptions?: Record<string, string>;\n      };\n\n      const environment = context.customResolverOptions?.environment;\n      const isNode = environment === 'node';\n\n      // TODO: We need to prevent the require.context from including API routes as these use externals.\n      // Should be fine after async routes lands.\n      if (isNode) {\n        const moduleId = isNodeExternal(moduleName);\n        if (moduleId) {\n          moduleName = getNodeExternalModuleId(context.originModulePath, moduleId);\n          debug(`Redirecting Node.js external \"${moduleId}\" to \"${moduleName}\"`);\n        }\n      }\n\n      // Conditionally remap `react-native` to `react-native-web` on web in\n      // a way that doesn't require Babel to resolve the alias.\n      if (platform && platform in aliases && aliases[platform][moduleName]) {\n        moduleName = aliases[platform][moduleName];\n      }\n\n      // TODO: We may be able to remove this in the future, it's doing no harm\n      // by staying here.\n      // Conditionally remap `react-native` to `react-native-web`\n      if (platform && platform in extraNodeModules) {\n        context.extraNodeModules = {\n          ...extraNodeModules[platform],\n          ...context.extraNodeModules,\n        };\n      }\n\n      if (tsconfig?.baseUrl && isTsconfigPathsEnabled) {\n        context = {\n          ...context,\n          nodeModulesPaths: [\n            ...immutableContext.nodeModulesPaths,\n            // add last to ensure node modules are resolved first\n            tsconfig.baseUrl,\n          ],\n        };\n      }\n\n      let mainFields: string[] = context.mainFields;\n\n      if (isNode) {\n        // Node.js runtimes should only be importing main at the moment.\n        // This is a temporary fix until we can support the package.json exports.\n        mainFields = ['main'];\n      } else if (env.EXPO_METRO_NO_MAIN_FIELD_OVERRIDE) {\n        mainFields = context.mainFields;\n      } else if (platform && platform in preferredMainFields) {\n        mainFields = preferredMainFields[platform];\n      }\n      function doResolve(moduleName: string): Resolution | null {\n        return resolve(\n          {\n            ...context,\n            preferNativePlatform: platform !== 'web',\n            resolveRequest: undefined,\n\n            mainFields,\n\n            // Passing `mainFields` directly won't be considered (in certain version of Metro)\n            // we need to extend the `getPackageMainPath` directly to\n            // use platform specific `mainFields`.\n            // @ts-ignore\n            getPackageMainPath(packageJsonPath) {\n              // @ts-expect-error: mainFields is not on type\n              const package_ = context.moduleCache.getPackage(packageJsonPath);\n              return package_.getMain(mainFields);\n            },\n          },\n          moduleName,\n          platform\n        );\n      }\n\n      function optionalResolve(moduleName: string): Resolution | null {\n        try {\n          return doResolve(moduleName);\n        } catch (error) {\n          // If the error is directly related to a resolver not being able to resolve a module, then\n          // we can ignore the error and try the next resolver. Otherwise, we should throw the error.\n          const isResolutionError =\n            isFailedToResolveNameError(error) || isFailedToResolvePathError(error);\n          if (!isResolutionError) {\n            throw error;\n          }\n        }\n        return null;\n      }\n\n      let result: Resolution | null = null;\n\n      if (tsConfigResolve) {\n        result = tsConfigResolve(\n          {\n            originModulePath: context.originModulePath,\n            moduleName,\n          },\n          optionalResolve\n        );\n      }\n\n      result ??= doResolve(moduleName);\n\n      if (result) {\n        // Replace the web resolver with the original one.\n        // This is basically an alias for web-only.\n        if (shouldAliasAssetRegistryForWeb(platform, result)) {\n          // @ts-expect-error: `readonly` for some reason.\n          result.filePath = assetRegistryPath;\n        }\n      }\n      return result;\n    },\n  ]);\n}\n\n/** @returns `true` if the incoming resolution should be swapped on web. */\nexport function shouldAliasAssetRegistryForWeb(\n  platform: string | null,\n  result: Resolution\n): boolean {\n  return (\n    platform === 'web' &&\n    result?.type === 'sourceFile' &&\n    typeof result?.filePath === 'string' &&\n    normalizeSlashes(result.filePath).endsWith(\n      'react-native-web/dist/modules/AssetRegistry/index.js'\n    )\n  );\n}\n\n/** Add support for `react-native-web` and the Web platform. */\nexport async function withMetroMultiPlatformAsync(\n  projectRoot: string,\n  {\n    config,\n    platformBundlers,\n    isTsconfigPathsEnabled,\n    webOutput,\n    routerDirectory,\n  }: {\n    config: ConfigT;\n    isTsconfigPathsEnabled: boolean;\n    platformBundlers: PlatformBundlers;\n    webOutput?: 'single' | 'static';\n    routerDirectory: string;\n  }\n) {\n  // Auto pick app entry for router.\n  process.env.EXPO_ROUTER_APP_ROOT = getAppRouterRelativeEntryPath(projectRoot, routerDirectory);\n\n  // Required for @expo/metro-runtime to format paths in the web LogBox.\n  process.env.EXPO_PUBLIC_PROJECT_ROOT = process.env.EXPO_PUBLIC_PROJECT_ROOT ?? projectRoot;\n\n  if (webOutput === 'static') {\n    // Enable static rendering in runtime space.\n    process.env.EXPO_PUBLIC_USE_STATIC = '1';\n  }\n\n  // Ensure the cache is invalidated if these values change.\n  // @ts-expect-error\n  config.transformer._expoRouterRootDirectory = process.env.EXPO_ROUTER_APP_ROOT;\n  // @ts-expect-error\n  config.transformer._expoRouterWebRendering = webOutput;\n  // TODO: import mode\n\n  if (platformBundlers.web === 'metro') {\n    await new WebSupportProjectPrerequisite(projectRoot).assertAsync();\n  } else if (!isTsconfigPathsEnabled) {\n    // Bail out early for performance enhancements if no special features are enabled.\n    return config;\n  }\n\n  let tsconfig: null | TsConfigPaths = null;\n\n  if (isTsconfigPathsEnabled) {\n    Log.warn(\n      chalk.yellow`Experimental path aliases feature is enabled. ` +\n        learnMore('https://docs.expo.dev/guides/typescript/#path-aliases')\n    );\n    tsconfig = await loadTsConfigPathsAsync(projectRoot);\n  }\n\n  await setupNodeExternals(projectRoot);\n\n  return withMetroMultiPlatform(projectRoot, {\n    config,\n    platformBundlers,\n    tsconfig,\n    isTsconfigPathsEnabled,\n  });\n}\n\nfunction withMetroMultiPlatform(\n  projectRoot: string,\n  {\n    config,\n    platformBundlers,\n    isTsconfigPathsEnabled,\n    tsconfig,\n  }: {\n    config: ConfigT;\n    isTsconfigPathsEnabled: boolean;\n    platformBundlers: PlatformBundlers;\n    tsconfig: TsConfigPaths | null;\n  }\n) {\n  let expoConfigPlatforms = Object.entries(platformBundlers)\n    .filter(([, bundler]) => bundler === 'metro')\n    .map(([platform]) => platform);\n\n  if (Array.isArray(config.resolver.platforms)) {\n    expoConfigPlatforms = [...new Set(expoConfigPlatforms.concat(config.resolver.platforms))];\n  }\n\n  // @ts-expect-error: typed as `readonly`.\n  config.resolver.platforms = expoConfigPlatforms;\n\n  if (expoConfigPlatforms.includes('web')) {\n    config = withWebPolyfills(config, projectRoot);\n  }\n\n  return withExtendedResolver(config, {\n    projectRoot,\n    tsconfig,\n    isTsconfigPathsEnabled,\n    platforms: expoConfigPlatforms,\n  });\n}\n"],"names":["withExtendedResolver","shouldAliasAssetRegistryForWeb","withMetroMultiPlatformAsync","debug","require","withWebPolyfills","config","projectRoot","originalGetPolyfills","serializer","getPolyfills","bind","ctx","platform","path","join","EXTERNAL_REQUIRE_POLYFILL","polyfills","EXTERNAL_REQUIRE_NATIVE_POLYFILL","normalizeSlashes","p","replace","tsconfig","platforms","isTsconfigPathsEnabled","assetRegistryPath","fs","realpathSync","resolve","resolveFrom","isWebEnabled","includes","importMetroResolverFromProject","extraNodeModules","aliases","web","preferredMainFields","tsConfigResolve","paths","resolveWithTsConfigPaths","baseUrl","isInteractive","configWatcher","FileNotifier","startObserving","loadTsConfigPathsAsync","then","tsConfigPaths","Object","keys","length","installExitHooks","stopObserving","withMetroResolvers","immutableContext","moduleName","context","environment","customResolverOptions","isNode","moduleId","isNodeExternal","getNodeExternalModuleId","originModulePath","nodeModulesPaths","mainFields","env","EXPO_METRO_NO_MAIN_FIELD_OVERRIDE","doResolve","preferNativePlatform","resolveRequest","undefined","getPackageMainPath","packageJsonPath","package_","moduleCache","getPackage","getMain","optionalResolve","error","isResolutionError","isFailedToResolveNameError","isFailedToResolvePathError","result","filePath","type","endsWith","platformBundlers","webOutput","routerDirectory","process","EXPO_ROUTER_APP_ROOT","getAppRouterRelativeEntryPath","EXPO_PUBLIC_PROJECT_ROOT","EXPO_PUBLIC_USE_STATIC","transformer","_expoRouterRootDirectory","_expoRouterWebRendering","WebSupportProjectPrerequisite","assertAsync","Log","warn","chalk","yellow","learnMore","setupNodeExternals","withMetroMultiPlatform","expoConfigPlatforms","entries","filter","bundler","map","Array","isArray","resolver","Set","concat"],"mappings":"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"}