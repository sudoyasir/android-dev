{"version":3,"sources":["../../../../../src/start/server/metro/runServer-fork.ts"],"sourcesContent":["// Copyright Â© 2023 650 Industries.\n// Copyright (c) Meta Platforms, Inc. and affiliates.\n//\n// Forks https://github.com/facebook/metro/blob/b80d9a0f638ee9fb82ff69cd3c8d9f4309ca1da2/packages/metro/src/index.flow.js#L57\n// and adds the ability to access the bundler instance.\nimport assert from 'assert';\nimport http from 'http';\nimport https from 'https';\nimport { RunServerOptions, Server } from 'metro';\nimport { ConfigT } from 'metro-config';\nimport type { InspectorProxy } from 'metro-inspector-proxy';\nimport { parse } from 'url';\n\nimport { env } from '../../../utils/env';\nimport type { ConnectAppType } from '../middleware/server.types';\nimport { MetroBundlerDevServer } from './MetroBundlerDevServer';\nimport { createInspectorProxy, ExpoInspectorProxy } from './inspector-proxy';\nimport {\n  importMetroCreateWebsocketServerFromProject,\n  importMetroFromProject,\n  importMetroHmrServerFromProject,\n  importMetroInspectorProxyFromProject,\n} from './resolveFromProject';\n\nexport const runServer = async (\n  metroBundler: MetroBundlerDevServer,\n  config: ConfigT,\n  {\n    hasReducedPerformance = false,\n    host,\n    onError,\n    onReady,\n    secureServerOptions,\n    waitForBundler = false,\n    websocketEndpoints = {},\n    watch,\n  }: RunServerOptions\n): Promise<{ server: http.Server | https.Server; metro: Server }> => {\n  const projectRoot = metroBundler.projectRoot;\n\n  const Metro = importMetroFromProject(projectRoot);\n\n  const createWebsocketServer = importMetroCreateWebsocketServerFromProject(projectRoot);\n\n  const MetroHmrServer = importMetroHmrServerFromProject(projectRoot);\n\n  // await earlyPortCheck(host, config.server.port);\n\n  // if (secure != null || secureCert != null || secureKey != null) {\n  //   // eslint-disable-next-line no-console\n  //   console.warn(\n  //     chalk.inverse.yellow.bold(' DEPRECATED '),\n  //     'The `secure`, `secureCert`, and `secureKey` options are now deprecated. ' +\n  //       'Please use the `secureServerOptions` object instead to pass options to ' +\n  //       \"Metro's https development server.\",\n  //   );\n  // }\n\n  const { middleware, end, metroServer } = await Metro.createConnectMiddleware(config, {\n    hasReducedPerformance,\n    waitForBundler,\n    watch,\n  });\n\n  assert(typeof (middleware as any).use === 'function');\n  const serverApp = middleware as ConnectAppType;\n\n  let inspectorProxy: InspectorProxy | ExpoInspectorProxy | null = null;\n  if (config.server.runInspectorProxy && !env.EXPO_NO_INSPECTOR_PROXY) {\n    inspectorProxy = createInspectorProxy(metroBundler, config.projectRoot);\n  } else if (config.server.runInspectorProxy) {\n    const { InspectorProxy } = importMetroInspectorProxyFromProject(projectRoot);\n    inspectorProxy = new InspectorProxy(config.projectRoot);\n  }\n\n  let httpServer: http.Server | https.Server;\n\n  if (secureServerOptions != null) {\n    httpServer = https.createServer(secureServerOptions, serverApp);\n  } else {\n    httpServer = http.createServer(serverApp);\n  }\n  return new Promise<{ server: http.Server | https.Server; metro: Server }>((resolve, reject) => {\n    httpServer.on('error', (error) => {\n      if (onError) {\n        onError(error);\n      }\n      reject(error);\n      end();\n    });\n\n    httpServer.listen(config.server.port, host, () => {\n      if (onReady) {\n        onReady(httpServer);\n      }\n\n      Object.assign(websocketEndpoints, {\n        ...(inspectorProxy ? { ...inspectorProxy.createWebSocketListeners(httpServer) } : {}),\n        '/hot': createWebsocketServer({\n          websocketServer: new MetroHmrServer(\n            metroServer.getBundler(),\n            metroServer.getCreateModuleId(),\n            config\n          ),\n        }),\n      });\n\n      httpServer.on('upgrade', (request, socket, head) => {\n        const { pathname } = parse(request.url!);\n        if (pathname != null && websocketEndpoints[pathname]) {\n          websocketEndpoints[pathname].handleUpgrade(request, socket, head, (ws) => {\n            websocketEndpoints[pathname].emit('connection', ws, request);\n          });\n        } else {\n          socket.destroy();\n        }\n      });\n\n      if (inspectorProxy) {\n        // TODO(hypuk): Refactor inspectorProxy.processRequest into separate request handlers\n        // so that we could provide routes (/json/list and /json/version) here.\n        // Currently this causes Metro to give warning about T31407894.\n        // $FlowFixMe[method-unbinding] added when improving typing for this parameters\n        serverApp.use(inspectorProxy.processRequest.bind(inspectorProxy));\n      }\n\n      resolve({ server: httpServer, metro: metroServer });\n    });\n\n    // Disable any kind of automatic timeout behavior for incoming\n    // requests in case it takes the packager more than the default\n    // timeout of 120 seconds to respond to a request.\n    httpServer.timeout = 0;\n\n    httpServer.on('close', () => {\n      end();\n    });\n  });\n};\n"],"names":["runServer","metroBundler","config","hasReducedPerformance","host","onError","onReady","secureServerOptions","waitForBundler","websocketEndpoints","watch","projectRoot","Metro","importMetroFromProject","createWebsocketServer","importMetroCreateWebsocketServerFromProject","MetroHmrServer","importMetroHmrServerFromProject","middleware","end","metroServer","createConnectMiddleware","assert","use","serverApp","inspectorProxy","server","runInspectorProxy","env","EXPO_NO_INSPECTOR_PROXY","createInspectorProxy","InspectorProxy","importMetroInspectorProxyFromProject","httpServer","https","createServer","http","Promise","resolve","reject","on","error","listen","port","Object","assign","createWebSocketListeners","websocketServer","getBundler","getCreateModuleId","request","socket","head","pathname","parse","url","handleUpgrade","ws","emit","destroy","processRequest","bind","metro","timeout"],"mappings":"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"}